name: Release

on:
  push:
    tags:
      - 'v*'           # Unified tags like v0.1.0, v1.0.0
      - 'meross-iot@*' # Package-specific tags like meross-iot@0.1.0
      - 'meross-cli@*' # Package-specific tags like meross-cli@0.1.0

jobs:
  release:
    name: Create GitHub Release and Publish to NPM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for npm provenance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog extraction
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Parse tag and extract package/version
        id: tag_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          # Check if it's a package-specific tag (e.g., meross-iot@0.1.0)
          if [[ "$TAG" =~ ^(meross-iot|meross-cli)@(.+)$ ]]; then
            PACKAGE="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_package_specific=true" >> $GITHUB_OUTPUT
            echo "changelog_path=packages/$PACKAGE/CHANGELOG.md" >> $GITHUB_OUTPUT
            echo "release_name=$PACKAGE v$VERSION" >> $GITHUB_OUTPUT
          # Check if it's a unified tag (e.g., v0.1.0)
          elif [[ "$TAG" =~ ^v(.+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            PACKAGE="meross-iot"
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_package_specific=true" >> $GITHUB_OUTPUT
            echo "changelog_path=packages/$PACKAGE/CHANGELOG.md" >> $GITHUB_OUTPUT
            echo "release_name=$PACKAGE v$VERSION" >> $GITHUB_OUTPUT
          else
            echo "Error: Unknown tag format: $TAG" >&2
            exit 1
          fi
          
          echo "Tag: $TAG"
          echo "Package: ${PACKAGE:-monorepo}"
          echo "Version: $VERSION"
      
      - name: Configure npm for provenance
        if: steps.tag_info.outputs.is_package_specific == 'true'
        run: npm config set provenance true
      
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.tag_info.outputs.version }}"
          TAG="${{ steps.tag_info.outputs.tag }}"
          CHANGELOG_PATH="${{ steps.tag_info.outputs.changelog_path }}"
          IS_PACKAGE_SPECIFIC="${{ steps.tag_info.outputs.is_package_specific }}"
          
          # Extract the changelog section for this version
          # This script extracts everything between ## [version] and the next ## section
          if [ -f "$CHANGELOG_PATH" ]; then
            awk -v version="$VERSION" '
              BEGIN { found=0; in_section=0 }
              /^## \[/ {
                if (in_section) exit
                if ($0 ~ "\\[" version "\\]") {
                  found=1
                  in_section=1
                  next
                }
              }
              in_section {
                if (/^## \[/ && !found) {
                  exit
                }
                print
              }
            ' "$CHANGELOG_PATH" > release_notes.txt
          fi
          
          # Fallback if changelog extraction failed or file doesn't exist
          if [ ! -s release_notes.txt ]; then
            PACKAGE_NAME="${{ steps.tag_info.outputs.package }}"
            if [ -n "$PACKAGE_NAME" ]; then
              echo "## [$VERSION] - $(date +%Y-%m-%d)" > release_notes.txt
              echo "" >> release_notes.txt
              echo "Release of $PACKAGE_NAME package." >> release_notes.txt
            else
              echo "## [$VERSION] - $(date +%Y-%m-%d)" > release_notes.txt
              echo "" >> release_notes.txt
              echo "See individual package changelogs for details:" >> release_notes.txt
              echo "- [meross-iot CHANGELOG](./packages/meross-iot/CHANGELOG.md)" >> release_notes.txt
              echo "- [meross-cli CHANGELOG](./packages/meross-cli/CHANGELOG.md)" >> release_notes.txt
            fi
          fi
          
          # Read the release notes
          RELEASE_NOTES=$(cat release_notes.txt)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also create a summary
          echo "## Release $TAG" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$RELEASE_NOTES" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Determine if prerelease
        id: prerelease
        run: |
          VERSION="${{ steps.tag_info.outputs.version }}"
          if [[ "$VERSION" == *"-"* ]] || [[ "$VERSION" =~ ^0\. ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install dependencies
        run: npm ci
        if: steps.tag_info.outputs.is_package_specific == 'true'
      
      - name: Update package version
        if: steps.tag_info.outputs.is_package_specific == 'true'
        run: |
          PACKAGE="${{ steps.tag_info.outputs.package }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          cd "packages/$PACKAGE"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
      
      - name: Fix meross-cli dependency for publishing
        if: steps.tag_info.outputs.package == 'meross-cli'
        run: |
          cd packages/meross-cli
          # Replace file: dependency with version range
          # Get the meross-iot version from its package.json
          MEROSS_IOT_VERSION=$(node -p "require('../meross-iot/package.json').version")
          # Use caret range to allow patch updates
          npm pkg set "dependencies.meross-iot=^$MEROSS_IOT_VERSION"
      
      - name: Install npm 11.5.1+ for trusted publishing
        if: steps.tag_info.outputs.is_package_specific == 'true'
        run: npm install -g npm@latest
      
      - name: Publish to NPM
        if: steps.tag_info.outputs.is_package_specific == 'true'
        run: |
          PACKAGE="${{ steps.tag_info.outputs.package }}"
          cd "packages/$PACKAGE"
          npm publish --access public --provenance
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: ${{ steps.tag_info.outputs.release_name }}
          body: ${{ steps.changelog.outputs.notes }}
          prerelease: ${{ steps.prerelease.outputs.prerelease == 'true' }}
          draft: false
